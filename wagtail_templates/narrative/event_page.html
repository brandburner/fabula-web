{% extends "base.html" %}
{% load wagtailcore_tags wagtailimages_tags narrative_tags %}

{% block title %}{{ page.title }}{% endblock %}

{% block series_context %}
<span class="text-slate-500 text-sm font-medium">
    S{{ page.episode.get_parent.specific.season_number }}E{{ page.episode.episode_number }} · {{ page.episode.title }}
</span>
{% endblock %}

{% block content %}
<article class="min-h-screen pb-16">
    {# Hero section with gradient #}
    <div class="relative overflow-hidden">
        <div class="absolute inset-0 bg-gradient-to-b from-amber-950/20 via-slate-950 to-slate-950"></div>
        <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-amber-900/10 via-transparent to-transparent"></div>
        
        <div class="relative max-w-4xl mx-auto px-6 pt-12 pb-8">
            {# Episode context badge #}
            <div class="flex items-center gap-2 text-sm text-slate-400 mb-4">
                <span class="font-mono text-amber-500/80">
                    S{{ page.episode.get_parent.specific.season_number }}E{{ page.episode.episode_number }}
                </span>
                <span class="text-slate-600">·</span>
                <a href="{% pageurl page.episode %}" class="text-slate-400 hover:text-slate-200 transition-colors">
                    {{ page.episode.title }}
                </a>
                {% if page.is_flashback %}
                <span class="ml-2 px-2 py-0.5 text-xs bg-purple-500/20 text-purple-400 border border-purple-500/30 rounded">
                    Flashback
                </span>
                {% endif %}
            </div>
            
            {# Event title #}
            <h1 class="text-3xl md:text-4xl font-bold text-white mb-6 leading-tight tracking-tight">
                {{ page.title }}
            </h1>
            
            {# Description #}
            <div class="text-lg text-slate-300 leading-relaxed max-w-3xl prose prose-invert">
                {{ page.description|richtext }}
            </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto px-6">
        {# Location card #}
        {% if page.location %}
        <div class="mb-8 p-4 bg-slate-900/50 border border-slate-800 rounded-lg">
            <div class="flex items-start gap-3">
                <div class="p-2 bg-blue-500/10 rounded-lg">
                    <i data-lucide="map-pin" class="w-5 h-5 text-blue-400"></i>
                </div>
                <div>
                    <div class="text-xs font-medium text-slate-500 uppercase tracking-wide mb-1">Location</div>
                    <div class="font-medium text-slate-200">{{ page.location.canonical_name }}</div>
                    {% if page.location.description %}
                    <div class="text-sm text-slate-400 mt-1">{{ page.location.description|truncatewords:30 }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <hr class="border-slate-800 mb-8">

        {# ============================================================= #}
        {# PARTICIPANTS SECTION #}
        {# ============================================================= #}
        <section class="mb-10">
            <div class="flex items-center gap-2 mb-6">
                <i data-lucide="users" class="w-5 h-5 text-emerald-400"></i>
                <h2 class="text-lg font-semibold text-white">Who Was There</h2>
                <span class="ml-2 px-2 py-0.5 text-xs bg-slate-800 text-slate-400 rounded">
                    {{ page.participations.count }}
                </span>
            </div>
            
            <div class="space-y-4" x-data="{ expanded: {} }">
                {% for participation in page.participations.all %}
                    {% include "includes/participation_card.html" with participation=participation %}
                {% empty %}
                <div class="text-slate-500 text-sm p-4 bg-slate-900/30 rounded-lg border border-slate-800/50">
                    No character participations recorded
                </div>
                {% endfor %}
            </div>
        </section>

        <hr class="border-slate-800 mb-8">

        {# ============================================================= #}
        {# NARRATIVE CONNECTIONS SECTION #}
        {# ============================================================= #}
        <section class="mb-10">
            <div class="flex items-center gap-2 mb-6">
                <i data-lucide="link-2" class="w-5 h-5 text-cyan-400"></i>
                <h2 class="text-lg font-semibold text-white">Narrative Connections</h2>
            </div>

            {% with incoming=page.incoming_connections.all outgoing=page.outgoing_connections.all %}
            
            {# What led here (incoming connections) #}
            {% if incoming %}
            <div class="mb-6">
                <div class="text-sm font-medium text-slate-500 mb-3 flex items-center gap-2">
                    <span class="text-slate-600">←</span> What led here
                </div>
                <div class="space-y-3">
                    {% for connection in incoming %}
                        {% include "includes/connection_card.html" with connection=connection direction="incoming" %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {# What this causes (outgoing connections) #}
            {% if outgoing %}
            <div class="mb-6">
                <div class="text-sm font-medium text-slate-500 mb-3 flex items-center gap-2">
                    <span class="text-slate-600">→</span> What this causes
                </div>
                <div class="space-y-3">
                    {% for connection in outgoing %}
                        {% include "includes/connection_card.html" with connection=connection direction="outgoing" %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {% if not incoming and not outgoing %}
            <div class="text-slate-500 text-sm p-4 bg-slate-900/30 rounded-lg border border-slate-800/50">
                No narrative connections mapped yet
            </div>
            {% endif %}
            
            {% endwith %}
        </section>

        <hr class="border-slate-800 mb-8">

        {# ============================================================= #}
        {# THEMES SECTION #}
        {# ============================================================= #}
        {% if page.themes.exists %}
        <section class="mb-10">
            <div class="flex items-center gap-2 mb-6">
                <i data-lucide="sparkles" class="w-5 h-5 text-violet-400"></i>
                <h2 class="text-lg font-semibold text-white">Themes This Exemplifies</h2>
            </div>
            
            <div class="space-y-3">
                {% for theme in page.themes.all %}
                <a href="{% url 'theme_detail' theme.pk %}"
                   class="block w-full text-left p-4 bg-slate-900/50 border border-slate-800 rounded-lg hover:border-violet-500/30 hover:bg-violet-500/5 transition-all group">
                    <div class="flex items-start justify-between gap-4">
                        <div>
                            <div class="font-medium text-slate-200 group-hover:text-violet-300 transition-colors">
                                {{ theme.name }}
                            </div>
                            <div class="text-sm text-slate-400 mt-1 line-clamp-2">
                                {{ theme.description|truncatewords:30 }}
                            </div>
                        </div>
                        <span class="shrink-0 px-2 py-0.5 text-xs bg-violet-500/10 text-violet-400 rounded">
                            {{ theme.events.count }} events
                        </span>
                    </div>
                </a>
                {% endfor %}
            </div>
        </section>
        {% endif %}

        {# ============================================================= #}
        {# CONFLICT ARCS SECTION #}
        {# ============================================================= #}
        {% if page.arcs.exists %}
        <section>
            <div class="flex items-center gap-2 mb-6">
                <i data-lucide="git-branch" class="w-5 h-5 text-orange-400"></i>
                <h2 class="text-lg font-semibold text-white">Part of Larger Arcs</h2>
            </div>
            
            <div class="flex flex-wrap gap-2">
                {% for arc in page.arcs.all %}
                <a href="{% url 'arc_detail' arc.pk %}"
                   class="px-3 py-1.5 text-sm border border-orange-500/30 text-orange-400 bg-orange-500/5 rounded-lg hover:bg-orange-500/10 transition-colors">
                    {{ arc.title }}
                </a>
                {% endfor %}
            </div>
        </section>
        {% endif %}

        {# ============================================================= #}
        {# KEY DIALOGUE (if exists) #}
        {# ============================================================= #}
        {% if page.key_dialogue %}
        <section class="mt-10">
            <div class="flex items-center gap-2 mb-6">
                <i data-lucide="quote" class="w-5 h-5 text-slate-400"></i>
                <h2 class="text-lg font-semibold text-white">Key Dialogue</h2>
            </div>
            
            <div class="space-y-3">
                {% for line in page.key_dialogue %}
                <blockquote class="pl-4 border-l-2 border-slate-700 text-slate-300 italic">
                    "{{ line }}"
                </blockquote>
                {% endfor %}
            </div>
        </section>
        {% endif %}

    </div>
</article>
{% endblock %}

{% block extra_js %}
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
{% endblock %}
