{% load wagtailcore_tags narrative_tags %}
{% if fabula_theme == 'writerly' %}
{# ===== WRITERLY EVENT CARD ===== #}
<a href="{% narrative_url event %}"
   class="block p-4 rounded-lg transition-all duration-200 group"
   style="background: var(--f-card-bg); border: 1px solid var(--f-card-border);"
   onmouseover="this.style.borderColor='var(--f-accent-primary)'; this.style.boxShadow='var(--f-card-shadow-hover)'"
   onmouseout="this.style.borderColor='var(--f-card-border)'; this.style.boxShadow='none'">

    {% if show_episode %}
    <div class="text-xs mb-1" style="color: var(--f-fg-placeholder); font-family: var(--f-font-mono);">
        {% get_episode_context event as ep %}{{ ep }} · {{ event.episode.title }}
    </div>
    {% endif %}

    <div class="font-medium mb-2 transition-colors" style="color: var(--f-fg-heading); font-family: var(--f-font-display);">
        {{ event.title|md }}
    </div>

    <p class="text-sm line-clamp-2" style="color: var(--f-fg-tertiary);">
        {{ event.description|md|striptags|truncatewords:25 }}
    </p>

    {# Metadata row #}
    <div class="flex items-center gap-4 mt-3 text-xs" style="color: var(--f-fg-placeholder);">
        {% if event.location %}
        <span class="flex items-center gap-1">
            <i data-lucide="map-pin" class="w-3 h-3"></i>
            {{ event.location.canonical_name|truncate_title:20 }}
        </span>
        {% endif %}

        <span class="flex items-center gap-1">
            <i data-lucide="users" class="w-3 h-3"></i>
            {{ event.participations.count }}
        </span>

        {% if show_connections %}
        {% with conn_count=event.incoming_connections.count|add:event.outgoing_connections.count %}
        {% if conn_count > 0 %}
        <span class="flex items-center gap-1">
            <i data-lucide="link-2" class="w-3 h-3"></i>
            {{ conn_count }}
        </span>
        {% endif %}
        {% endwith %}
        {% endif %}
    </div>
</a>

{% else %}
{# ===== DARK EVENT CARD (original) ===== #}
<a href="{% narrative_url event %}"
   class="block p-4 bg-slate-900/50 border border-slate-800 rounded-lg hover:border-amber-500/30 hover:bg-amber-500/5 transition-all group">

    {% if show_episode %}
    <div class="text-xs text-slate-500 font-mono mb-1">
        {% get_episode_context event as ep %}{{ ep }} · {{ event.episode.title }}
    </div>
    {% endif %}

    <div class="font-medium text-slate-200 group-hover:text-amber-300 transition-colors mb-2">
        {{ event.title|md }}
    </div>

    <p class="text-sm text-slate-400 line-clamp-2">
        {{ event.description|md|striptags|truncatewords:25 }}
    </p>

    {# Metadata row #}
    <div class="flex items-center gap-4 mt-3 text-xs text-slate-500">
        {% if event.location %}
        <span class="flex items-center gap-1">
            <i data-lucide="map-pin" class="w-3 h-3"></i>
            {{ event.location.canonical_name|truncate_title:20 }}
        </span>
        {% endif %}

        <span class="flex items-center gap-1">
            <i data-lucide="users" class="w-3 h-3"></i>
            {{ event.participations.count }}
        </span>

        {% if show_connections %}
        {% with conn_count=event.incoming_connections.count|add:event.outgoing_connections.count %}
        {% if conn_count > 0 %}
        <span class="flex items-center gap-1">
            <i data-lucide="link-2" class="w-3 h-3"></i>
            {{ conn_count }}
        </span>
        {% endif %}
        {% endwith %}
        {% endif %}
    </div>
</a>
{% endif %}
