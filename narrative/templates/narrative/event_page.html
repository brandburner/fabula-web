{% extends "base.html" %}
{% load wagtailcore_tags wagtailimages_tags narrative_tags %}

{% block title %}{{ page.title|md_plain }}{% endblock %}

{% block series_context %}
<span class="text-slate-500 text-sm font-medium">
    S{{ page.episode.get_parent.specific.season_number }}E{{ page.episode.episode_number }} · {{ page.episode.title }}
</span>
{% endblock %}

{% block content %}
<article class="min-h-screen pb-16 fade-in">
    {# Hero section with gradient #}
    <div class="relative overflow-hidden">
        <div class="absolute inset-0 bg-gradient-to-b from-amber-950/20 via-slate-950 to-slate-950 animate-gradient"></div>
        <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-amber-900/15 via-transparent to-transparent"></div>
        <div class="absolute inset-0 bg-[radial-gradient(circle_at_bottom_right,_var(--tw-gradient-stops))] from-orange-900/10 via-transparent to-transparent"></div>

        <div class="relative max-w-4xl mx-auto px-6 pt-16 pb-10">
            {# Episode context badge #}
            <div class="flex items-center gap-2 text-sm text-slate-400 mb-6 flex-wrap">
                <div class="flex items-center gap-2 px-3 py-1.5 bg-amber-500/10 border border-amber-500/20 rounded-lg">
                    <i data-lucide="film" class="w-3.5 h-3.5 text-amber-400"></i>
                    <span class="font-mono text-amber-400 font-medium">
                        S{{ page.episode.get_parent.specific.season_number }}E{{ page.episode.episode_number }}
                    </span>
                </div>
                <span class="text-slate-700">·</span>
                <a href="{% narrative_url page.episode %}" class="text-slate-400 hover:text-amber-300 transition-colors hover:underline decoration-amber-500/30 underline-offset-4">
                    {{ page.episode.title }}
                </a>
                {% if page.is_flashback %}
                <span class="px-3 py-1 text-xs bg-purple-500/15 text-purple-300 border border-purple-500/30 rounded-full font-medium">
                    <i data-lucide="rewind" class="w-3 h-3 inline-block mr-1"></i>
                    Flashback
                </span>
                {% endif %}
            </div>

            {# Event title #}
            <h1 class="text-4xl md:text-5xl font-bold text-white mb-8 leading-tight tracking-tight bg-clip-text">
                {{ page.title|md }}
            </h1>

            {# Description #}
            <div class="text-xl text-slate-300 leading-relaxed max-w-3xl prose prose-lg prose-invert prose-amber">
                {{ page.description|md }}
            </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto px-6">
        {# ============================================================= #}
        {# PLOT BEATS - the micro-narrative breakdown #}
        {# ============================================================= #}
        {% with beats=page.beat_links.all %}
        {% if beats %}
        <section class="mb-10">
            <div class="flex items-center gap-3 mb-6">
                <div class="p-2 bg-pink-500/10 rounded-lg">
                    <i data-lucide="activity" class="w-5 h-5 text-pink-400"></i>
                </div>
                <div class="flex-1">
                    <h2 class="text-lg font-bold text-white">Plot Beats</h2>
                    <p class="text-sm text-slate-500 mt-0.5">The narrative micro-steps within this event</p>
                </div>
                <span class="px-2.5 py-1 text-xs font-semibold bg-pink-500/10 text-pink-400 border border-pink-500/20 rounded-lg">
                    {{ beats.count }}
                </span>
            </div>

            <div class="relative pl-6 border-l-2 border-pink-500/20 space-y-4">
                {% for link in beats %}
                {% with beat=link.plot_beat %}
                <div class="relative before:absolute before:left-[-25px] before:top-3 before:w-2.5 before:h-2.5 before:rounded-full before:bg-pink-500/60 before:border-2 before:border-slate-950">
                    <div class="p-4 bg-gradient-to-br from-slate-900/50 to-slate-900/30 border border-slate-800/70 rounded-xl">
                        {% if beat.action_description %}
                        <p class="text-sm text-slate-300 leading-relaxed">{{ beat.action_description }}</p>
                        {% endif %}

                        <div class="flex items-center flex-wrap gap-3 mt-3 text-xs text-slate-500">
                            {% if beat.emotional_shift %}
                            <span class="flex items-center gap-1.5 px-2 py-1 bg-pink-500/5 border border-pink-500/10 rounded text-pink-300/70">
                                <i data-lucide="heart" class="w-3 h-3"></i>
                                {{ beat.emotional_shift|truncatewords:8 }}
                            </span>
                            {% endif %}
                            {% if beat.setting_details %}
                            <span class="flex items-center gap-1.5 px-2 py-1 bg-slate-800/50 rounded">
                                <i data-lucide="map-pin" class="w-3 h-3 text-blue-400/60"></i>
                                {{ beat.setting_details|truncatewords:6 }}
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endwith %}
                {% endfor %}
            </div>
        </section>
        {% endif %}
        {% endwith %}

        {# Location card - only show if no rich involvement data exists for this location #}
        {% if page.location and not page.primary_location_has_involvement %}
        <div class="mb-10 p-5 bg-gradient-to-br from-slate-900/50 to-slate-900/30 border border-slate-800/70 rounded-xl hover:border-blue-500/30 transition-all duration-300 hover:shadow-lg hover:shadow-blue-500/5 group">
            <div class="flex items-start gap-4">
                <div class="p-3 bg-blue-500/10 rounded-xl border border-blue-500/20 group-hover:bg-blue-500/15 transition-colors">
                    <i data-lucide="map-pin" class="w-6 h-6 text-blue-400"></i>
                </div>
                <div class="flex-1">
                    <div class="text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2">Location</div>
                    <div class="font-semibold text-slate-100 text-lg mb-1">{{ page.location.canonical_name }}</div>
                    {% if page.location.description %}
                    <div class="text-sm text-slate-400 leading-relaxed">{{ page.location.description|truncatewords:30 }}</div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <hr class="border-slate-800/50 mb-10">

        {# ============================================================= #}
        {# PARTICIPANTS SECTION #}
        {# ============================================================= #}
        {% with parts=page.get_participations_by_importance %}
        <section class="mb-12">
            <div class="flex items-center gap-3 mb-8">
                <div class="p-2 bg-emerald-500/10 rounded-lg">
                    <i data-lucide="users" class="w-6 h-6 text-emerald-400"></i>
                </div>
                <div class="flex-1">
                    <h2 class="text-2xl font-bold text-white">Who Was There</h2>
                    <p class="text-sm text-slate-500 mt-0.5">Characters present in this moment</p>
                </div>
                <span class="px-3 py-1.5 text-sm font-semibold bg-emerald-500/10 text-emerald-400 border border-emerald-500/20 rounded-lg">
                    {{ page.participations.count }}
                </span>
            </div>

            {# Primary participants - the main actors #}
            {% if parts.primary %}
            <div class="space-y-4 stagger-children mb-8" x-data="{ expanded: {} }">
                {% for participation in parts.primary %}
                    {% include "includes/participation_card.html" with participation=participation %}
                {% endfor %}
            </div>
            {% endif %}

            {# Secondary participants - supporting roles #}
            {% if parts.secondary %}
            <div class="mb-8">
                <div class="flex items-center gap-2 text-sm font-semibold text-slate-400 mb-4 uppercase tracking-wider">
                    <i data-lucide="users" class="w-4 h-4 text-slate-500"></i>
                    <span>Supporting</span>
                    <span class="px-2 py-0.5 text-xs bg-slate-800 text-slate-500 rounded">{{ parts.secondary|length }}</span>
                </div>
                <div class="space-y-3" x-data="{ expanded: {} }">
                    {% for participation in parts.secondary %}
                        {% include "includes/participation_card.html" with participation=participation %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {# Mentioned characters - referenced but not physically present #}
            {% if parts.mentioned %}
            <div x-data="{ showMentioned: false }">
                <button @click="showMentioned = !showMentioned"
                        class="flex items-center gap-2 text-sm font-semibold text-slate-500 hover:text-slate-400 transition-colors mb-4 uppercase tracking-wider">
                    <i data-lucide="message-circle" class="w-4 h-4"></i>
                    <span>Mentioned</span>
                    <span class="px-2 py-0.5 text-xs bg-slate-800/50 text-slate-600 rounded">{{ parts.mentioned|length }}</span>
                    <i data-lucide="chevron-down" class="w-4 h-4 transition-transform" :class="{ 'rotate-180': showMentioned }"></i>
                </button>
                <div x-show="showMentioned" x-collapse class="space-y-3">
                    {% for participation in parts.mentioned %}
                    <div class="p-4 bg-slate-900/30 border border-slate-800/50 rounded-xl opacity-75">
                        <a href="{% narrative_url participation.character %}" class="font-medium text-slate-300 hover:text-emerald-400 transition-colors">
                            {{ participation.character.canonical_name }}
                        </a>
                        {% if participation.what_happened %}
                        <p class="text-sm text-slate-500 mt-1">{{ participation.what_happened|md|striptags|truncatewords:20 }}</p>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {# Empty state #}
            {% if not parts.primary and not parts.secondary and not parts.mentioned %}
            <div class="text-slate-500 text-sm p-6 bg-slate-900/30 rounded-xl border border-slate-800/50 text-center">
                <i data-lucide="user-x" class="w-8 h-8 mx-auto mb-2 text-slate-700"></i>
                <p>No character participations recorded</p>
            </div>
            {% endif %}
        </section>
        {% endwith %}

        {# ============================================================= #}
        {# OBJECT INVOLVEMENTS SECTION #}
        {# ============================================================= #}
        {% if page.object_involvements.exists %}
        <section class="mb-12">
            <div class="flex items-center gap-3 mb-8">
                <div class="p-2 bg-amber-500/10 rounded-lg">
                    <i data-lucide="box" class="w-6 h-6 text-amber-400"></i>
                </div>
                <div class="flex-1">
                    <h2 class="text-2xl font-bold text-white">Objects Involved</h2>
                    <p class="text-sm text-slate-500 mt-0.5">Significant items in this scene</p>
                </div>
                <span class="px-3 py-1.5 text-sm font-semibold bg-amber-500/10 text-amber-400 border border-amber-500/20 rounded-lg">
                    {{ page.object_involvements.count }}
                </span>
            </div>

            <div class="space-y-4">
                {% for involvement in page.object_involvements.all %}
                    {% include "includes/object_involvement_card.html" with involvement=involvement %}
                {% endfor %}
            </div>
        </section>
        {% endif %}

        {# ============================================================= #}
        {# LOCATION INVOLVEMENTS SECTION #}
        {# ============================================================= #}
        {% if page.location_involvements.exists %}
        <section class="mb-12">
            <div class="flex items-center gap-3 mb-8">
                <div class="p-2 bg-blue-500/10 rounded-lg">
                    <i data-lucide="map-pin" class="w-6 h-6 text-blue-400"></i>
                </div>
                <div class="flex-1">
                    <h2 class="text-2xl font-bold text-white">Location Details</h2>
                    <p class="text-sm text-slate-500 mt-0.5">Places and their significance in this event</p>
                </div>
                <span class="px-3 py-1.5 text-sm font-semibold bg-blue-500/10 text-blue-400 border border-blue-500/20 rounded-lg">
                    {{ page.location_involvements.count }}
                </span>
            </div>

            <div class="space-y-4">
                {% for involvement in page.location_involvements.all %}
                    {% include "includes/location_involvement_card.html" with involvement=involvement %}
                {% endfor %}
            </div>
        </section>
        {% endif %}

        {# ============================================================= #}
        {# ORGANIZATION INVOLVEMENTS SECTION #}
        {# ============================================================= #}
        {% if page.organization_involvements.exists %}
        <section class="mb-12">
            <div class="flex items-center gap-3 mb-8">
                <div class="p-2 bg-indigo-500/10 rounded-lg">
                    <i data-lucide="building-2" class="w-6 h-6 text-indigo-400"></i>
                </div>
                <div class="flex-1">
                    <h2 class="text-2xl font-bold text-white">Organizations Involved</h2>
                    <p class="text-sm text-slate-500 mt-0.5">Institutional presence and influence</p>
                </div>
                <span class="px-3 py-1.5 text-sm font-semibold bg-indigo-500/10 text-indigo-400 border border-indigo-500/20 rounded-lg">
                    {{ page.organization_involvements.count }}
                </span>
            </div>

            <div class="space-y-4">
                {% for involvement in page.organization_involvements.all %}
                    {% include "includes/organization_involvement_card.html" with involvement=involvement %}
                {% endfor %}
            </div>
        </section>
        {% endif %}

        <hr class="border-slate-800/50 mb-10">

        {# ============================================================= #}
        {# NARRATIVE CONNECTIONS SECTION #}
        {# ============================================================= #}
        <section class="mb-12">
            <div class="flex items-center gap-3 mb-8">
                <div class="p-2 bg-cyan-500/10 rounded-lg">
                    <i data-lucide="git-branch" class="w-6 h-6 text-cyan-400"></i>
                </div>
                <div class="flex-1">
                    <h2 class="text-2xl font-bold text-white">Narrative Connections</h2>
                    <p class="text-sm text-slate-500 mt-0.5">How this event relates to others in the story</p>
                </div>
            </div>

            {% with incoming=page.incoming_connections.all outgoing=page.outgoing_connections.all %}

            {# What led here (incoming connections) #}
            {% if incoming %}
            <div class="mb-8">
                <div class="flex items-center gap-2 text-sm font-semibold text-slate-400 mb-4 uppercase tracking-wider">
                    <i data-lucide="arrow-down" class="w-4 h-4 text-cyan-500"></i>
                    <span>What led here</span>
                    <span class="px-2 py-0.5 text-xs bg-slate-800 text-slate-500 rounded">{{ incoming.count }}</span>
                </div>
                <div class="space-y-3 stagger-children">
                    {% for connection in incoming %}
                        {% include "includes/connection_card.html" with connection=connection direction="incoming" %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {# What this causes (outgoing connections) #}
            {% if outgoing %}
            <div class="mb-6">
                <div class="flex items-center gap-2 text-sm font-semibold text-slate-400 mb-4 uppercase tracking-wider">
                    <i data-lucide="arrow-up" class="w-4 h-4 text-amber-500"></i>
                    <span>What this causes</span>
                    <span class="px-2 py-0.5 text-xs bg-slate-800 text-slate-500 rounded">{{ outgoing.count }}</span>
                </div>
                <div class="space-y-3 stagger-children">
                    {% for connection in outgoing %}
                        {% include "includes/connection_card.html" with connection=connection direction="outgoing" %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            {% if not incoming and not outgoing %}
            <div class="text-slate-500 text-sm p-8 bg-slate-900/30 rounded-xl border border-slate-800/50 text-center">
                <i data-lucide="link-2-off" class="w-10 h-10 mx-auto mb-3 text-slate-700"></i>
                <p class="font-medium">No narrative connections mapped yet</p>
                <p class="text-xs text-slate-600 mt-1">This event is currently isolated in the narrative graph</p>
            </div>
            {% endif %}

            {% endwith %}
        </section>

        <hr class="border-slate-800/50 mb-10">

        {# ============================================================= #}
        {# THEMES SECTION #}
        {# ============================================================= #}
        {% if page.themes.exists %}
        <section class="mb-12">
            <div class="flex items-center gap-3 mb-6">
                <div class="p-2 bg-violet-500/10 rounded-lg">
                    <i data-lucide="sparkles" class="w-6 h-6 text-violet-400"></i>
                </div>
                <div class="flex-1">
                    <h2 class="text-2xl font-bold text-white">Themes This Exemplifies</h2>
                    <p class="text-sm text-slate-500 mt-0.5">Thematic resonance and meaning</p>
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-4">
                {% for theme in page.themes.all %}
                <a href="{{ theme.get_absolute_url }}"
                   class="group block p-5 bg-gradient-to-br from-slate-900/50 to-slate-900/30 border border-slate-800 rounded-xl hover:border-violet-500/40 hover:bg-violet-500/5 transition-all duration-300 hover:shadow-lg hover:shadow-violet-500/10 hover:-translate-y-1">
                    <div class="flex items-start justify-between gap-4 mb-3">
                        <div class="font-semibold text-slate-200 group-hover:text-violet-300 transition-colors leading-snug">
                            {{ theme.name }}
                        </div>
                        <span class="shrink-0 px-2 py-1 text-xs bg-violet-500/15 text-violet-300 border border-violet-500/20 rounded font-medium">
                            {{ theme.events.count }}
                        </span>
                    </div>
                    <div class="text-sm text-slate-400 line-clamp-2 leading-relaxed">
                        {{ theme.description|truncatewords:25 }}
                    </div>
                </a>
                {% endfor %}
            </div>
        </section>
        {% endif %}

        {# ============================================================= #}
        {# CONFLICT ARCS SECTION #}
        {# ============================================================= #}
        {% if page.arcs.exists %}
        <section>
            <div class="flex items-center gap-2 mb-6">
                <i data-lucide="git-branch" class="w-5 h-5 text-orange-400"></i>
                <h2 class="text-lg font-semibold text-white">Part of Larger Arcs</h2>
            </div>
            
            <div class="flex flex-wrap gap-2">
                {% for arc in page.arcs.all %}
                <a href="{{ arc.get_absolute_url }}"
                   class="px-3 py-1.5 text-sm border border-orange-500/30 text-orange-400 bg-orange-500/5 rounded-lg hover:bg-orange-500/10 transition-colors">
                    {{ arc.title }}
                </a>
                {% endfor %}
            </div>
        </section>
        {% endif %}

        {# ============================================================= #}
        {# KEY DIALOGUE (if exists) #}
        {# ============================================================= #}
        {% if page.key_dialogue %}
        <section class="mt-10">
            <div class="flex items-center gap-2 mb-6">
                <i data-lucide="quote" class="w-5 h-5 text-slate-400"></i>
                <h2 class="text-lg font-semibold text-white">Key Dialogue</h2>
            </div>
            
            <div class="space-y-3">
                {% for line in page.key_dialogue %}
                <blockquote class="pl-4 border-l-2 border-slate-700 text-slate-300 italic">
                    "{{ line }}"
                </blockquote>
                {% endfor %}
            </div>
        </section>
        {% endif %}

    </div>
</article>
{% endblock %}

{% block extra_js %}
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
{% endblock %}
