{% extends "base.html" %}
{% load wagtailcore_tags narrative_tags %}

{% block title %}{{ connection.get_connection_type_display }} Connection{% endblock %}

{% block series_context %}
<span class="text-slate-500 text-sm font-medium">Narrative Connection</span>
{% endblock %}

{% block content %}
{% with conn_type=connection.connection_type|lower|slugify %}
<article class="min-h-screen pb-16 conn-{{ conn_type }} fade-in">
    {# Hero section with enhanced gradients #}
    <div class="relative overflow-hidden">
        {# Dynamic gradient based on connection type #}
        <div class="absolute inset-0 bg-gradient-to-b via-slate-950 to-slate-950 animate-gradient"
             style="--tw-gradient-from: color-mix(in srgb, var(--conn-color) 15%, transparent);"></div>
        <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))]"
             style="--tw-gradient-from: color-mix(in srgb, var(--conn-color) 12%, transparent);"></div>
        <div class="absolute inset-0 bg-[radial-gradient(circle_at_bottom_right,_var(--tw-gradient-stops))]"
             style="--tw-gradient-from: color-mix(in srgb, var(--conn-color) 8%, transparent);"></div>

        <div class="relative max-w-4xl mx-auto px-6 pt-16 pb-10">
            {# Connection type badges #}
            <div class="flex items-center gap-3 mb-8 flex-wrap">
                <span class="conn-badge inline-flex items-center gap-2 px-4 py-2 text-base font-semibold border-2 rounded-lg shadow-lg transition-all duration-300 hover:scale-105">
                    {% include "includes/connection_icon.html" with conn_type=connection.connection_type %}
                    {{ connection.get_connection_type_display }}
                </span>
                <span class="px-3 py-1.5 text-sm bg-slate-800/60 text-slate-300 border border-slate-700 rounded-lg font-medium capitalize">
                    {{ connection.strength }} strength
                </span>
            </div>

            {# Page title #}
            <h1 class="text-4xl md:text-5xl font-bold text-white mb-4 leading-tight tracking-tight">
                Narrative Connection
            </h1>
            <p class="text-xl text-slate-400">
                How these two moments in the story relate
            </p>
        </div>
    </div>

    <div class="max-w-4xl mx-auto px-6">
        {# ============================================================= #}
        {# CONNECTION VISUALIZATION - The Core Visual #}
        {# ============================================================= #}
        <div class="relative py-10">
            {# From event - Source #}
            <a href="{% pageurl connection.from_event %}"
               class="group block p-6 bg-gradient-to-br from-slate-900/70 to-slate-900/50 border-2 border-slate-800 rounded-xl hover:border-slate-700 transition-all duration-300 mb-6 hover:shadow-2xl hover:shadow-slate-900/50 hover:-translate-y-1">
                <div class="flex items-center gap-2 mb-3">
                    <div class="text-xs font-bold text-slate-500 uppercase tracking-wider px-2 py-1 bg-slate-800/50 rounded">From</div>
                    <i data-lucide="arrow-down-right" class="w-4 h-4 text-slate-600"></i>
                </div>
                <div class="text-xl font-bold text-slate-200 group-hover:text-white transition-colors mb-3 leading-tight">
                    {{ connection.from_event.title }}
                </div>
                <div class="flex items-center gap-2 text-sm text-slate-400">
                    <span class="px-2 py-0.5 bg-slate-800/50 rounded font-mono">
                        S{{ connection.from_event.episode.get_parent.specific.season_number }}E{{ connection.from_event.episode.episode_number }}
                    </span>
                    <span class="text-slate-600">·</span>
                    <span>{{ connection.from_event.episode.title }}</span>
                </div>
            </a>

            {# Connection indicator - Visual emphasis #}
            <div class="flex justify-center my-6 relative">
                <div class="absolute top-1/2 left-0 right-0 h-px" style="background: linear-gradient(to right, transparent, var(--conn-color), transparent); opacity: 0.3;"></div>
                <div class="conn-badge relative p-4 rounded-2xl border-2 shadow-xl transition-all duration-300 hover:scale-110" style="box-shadow: 0 0 30px color-mix(in srgb, var(--conn-color) 30%, transparent);">
                    <i data-lucide="arrow-down" class="w-6 h-6"></i>
                </div>
            </div>

            {# To event - Target #}
            <a href="{% pageurl connection.to_event %}"
               class="group block p-6 bg-gradient-to-br from-slate-900/70 to-slate-900/50 border-2 border-slate-800 rounded-xl hover:border-slate-700 transition-all duration-300 mt-6 hover:shadow-2xl hover:shadow-slate-900/50 hover:-translate-y-1">
                <div class="flex items-center gap-2 mb-3">
                    <div class="text-xs font-bold text-slate-500 uppercase tracking-wider px-2 py-1 bg-slate-800/50 rounded">To</div>
                    <i data-lucide="arrow-up-right" class="w-4 h-4 text-slate-600"></i>
                </div>
                <div class="text-xl font-bold text-slate-200 group-hover:text-white transition-colors mb-3 leading-tight">
                    {{ connection.to_event.title }}
                </div>
                <div class="flex items-center gap-2 text-sm text-slate-400">
                    <span class="px-2 py-0.5 bg-slate-800/50 rounded font-mono">
                        S{{ connection.to_event.episode.get_parent.specific.season_number }}E{{ connection.to_event.episode.episode_number }}
                    </span>
                    <span class="text-slate-600">·</span>
                    <span>{{ connection.to_event.episode.title }}</span>
                </div>
            </a>
        </div>

        <hr class="border-slate-800/50 mb-10">

        {# ============================================================= #}
        {# THE NARRATIVE ASSERTION - The Heart of the Connection #}
        {# ============================================================= #}
        <section class="mb-12">
            <div class="flex items-center gap-3 mb-6">
                <div class="p-2 rounded-lg" style="background-color: color-mix(in srgb, var(--conn-color) 15%, transparent);">
                    <i data-lucide="quote" class="w-6 h-6" style="color: var(--conn-color)"></i>
                </div>
                <div class="flex-1">
                    <h2 class="text-2xl font-bold text-white">Why These Connect</h2>
                    <p class="text-sm text-slate-500 mt-0.5">The narrative assertion</p>
                </div>
            </div>

            <div class="conn-card p-8 border-2 rounded-2xl relative overflow-hidden shadow-xl transition-all duration-300 hover:scale-[1.01]">
                <div class="absolute top-0 left-0 right-0 h-1" style="background: linear-gradient(to right, transparent, var(--conn-color), transparent);"></div>
                <p class="text-2xl text-slate-100 leading-relaxed font-serif italic">
                    "{{ connection.description }}"
                </p>
            </div>
        </section>

        {# ============================================================= #}
        {# CONNECTION TYPE EXPLANATION #}
        {# ============================================================= #}
        <section class="mb-12">
            <div class="flex items-center gap-3 mb-6">
                <div class="conn-badge p-2.5 rounded-lg border">
                    {% include "includes/connection_icon.html" with conn_type=connection.connection_type %}
                </div>
                <h2 class="text-xl font-bold" style="color: var(--conn-color)">
                    About {{ connection.get_connection_type_display }} Connections
                </h2>
            </div>

            <div class="p-6 bg-gradient-to-br from-slate-900/50 to-slate-900/30 border border-slate-800 rounded-xl">
                <p class="text-slate-300 leading-relaxed text-lg">
                {% if connection.connection_type == 'CAUSAL' %}
                    A directly causes B. The first event sets forces in motion that produce the second. 
                    These are the load-bearing connections of plot—remove one and the story structure collapses.
                {% elif connection.connection_type == 'FORESHADOWING' %}
                    A hints at B. The first event plants narrative seeds that pay off later. 
                    These connections reward attentive viewers with a sense of inevitability on rewatch.
                {% elif connection.connection_type == 'THEMATIC_PARALLEL' %}
                    A and B explore the same theme from different angles. They resonate without direct causation, 
                    creating meaning through juxtaposition and echo.
                {% elif connection.connection_type == 'CHARACTER_CONTINUITY' %}
                    A character's state in A evolves into their state in B. The same person, changed by time—
                    tracking how experience shapes identity across the narrative.
                {% elif connection.connection_type == 'ESCALATION' %}
                    B raises the stakes established in A. The conflict intensifies, the pressure increases, 
                    the consequences grow more severe. The ratchet tightens.
                {% elif connection.connection_type == 'CALLBACK' %}
                    B explicitly references A. A later moment deliberately echoes an earlier one, 
                    creating a sense of narrative completeness and rewarding memory.
                {% elif connection.connection_type == 'EMOTIONAL_ECHO' %}
                    B evokes the same emotional register as A. The feeling rhymes even if the circumstances differ—
                    creating emotional continuity across the narrative.
                {% elif connection.connection_type == 'SYMBOLIC_PARALLEL' %}
                    A and B share symbolic meaning. Objects, gestures, or images recur with accumulated significance,
                    building a visual or symbolic vocabulary for the story.
                {% elif connection.connection_type == 'TEMPORAL' %}
                    A and B are connected by their placement in time—flashback, flash-forward, 
                    or simultaneous action that creates meaning through temporal structure.
                {% else %}
                    These events are narratively connected, contributing to the overall story structure.
                {% endif %}
                </p>
            </div>
        </section>

        {# ============================================================= #}
        {# RELATED CONNECTIONS #}
        {# ============================================================= #}
        {% with from_connections=connection.from_event.outgoing_connections.all to_connections=connection.to_event.incoming_connections.all %}
        {% if from_connections.count > 1 or to_connections.count > 1 %}
        <section>
            <div class="flex items-center gap-2 mb-4">
                <i data-lucide="git-branch" class="w-5 h-5 text-slate-400"></i>
                <h2 class="text-lg font-semibold text-white">Related Connections</h2>
            </div>
            
            <div class="grid md:grid-cols-2 gap-4">
                {# Other connections from the source event #}
                {% for other in from_connections %}
                {% if other.pk != connection.pk %}
                <a href="{{ other.get_absolute_url }}"
                   class="p-3 bg-slate-900/50 border border-slate-800 rounded-lg hover:border-slate-700 transition-colors text-sm">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="conn-{{ other.connection_type|lower|slugify }} conn-badge px-1.5 py-0.5 text-xs border rounded">
                            {{ other.get_connection_type_display }}
                        </span>
                    </div>
                    <div class="text-slate-300">
                        → {{ other.to_event.title|truncatewords:6 }}
                    </div>
                </a>
                {% endif %}
                {% endfor %}
                
                {# Other connections to the target event #}
                {% for other in to_connections %}
                {% if other.pk != connection.pk %}
                <a href="{{ other.get_absolute_url }}"
                   class="p-3 bg-slate-900/50 border border-slate-800 rounded-lg hover:border-slate-700 transition-colors text-sm">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="conn-{{ other.connection_type|lower|slugify }} conn-badge px-1.5 py-0.5 text-xs border rounded">
                            {{ other.get_connection_type_display }}
                        </span>
                    </div>
                    <div class="text-slate-300">
                        ← {{ other.from_event.title|truncatewords:6 }}
                    </div>
                </a>
                {% endif %}
                {% endfor %}
            </div>
        </section>
        {% endif %}
        {% endwith %}

    </div>
</article>
{% endwith %}
{% endblock %}
